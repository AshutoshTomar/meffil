```{r norm-init, echo=FALSE}

library(knitr)
library(Cairo)
library(gridExtra)
opts_chunk$set(warning=FALSE, echo=FALSE, message=FALSE, results="asis", fig.width=12, fig.height=12, dev="CairoPNG")

```

# Normalization performance report
- study: `r study`
- author: `r author`
- date: `r format(Sys.time(), '%d %B, %Y')`

## Parameters used to test normalization

```{r norm-parameters, results="markup"}

normalization.summary$parameters

```

## Control probe scree plots

The variance captured by each principal component

```{r scree-plots}

do.call(grid.arrange, normalization.summary$scree.plot$graphs)

```

```{r control-batch-pca-option}
child.filename <- file.path(path, "blank.rmd")
if (!is.null(normalization.summary$control.batch$pc.plot))
    child.filename <- file.path(path, "control-batch-pca.rmd")
```

```{r control-batch-pca-child, child=child.filename}
```

## Control probe associations with measured batch variables

Principal components of the control probes were regressed against batch variables.
Shown are the $-log_{10}$ p-values for these regressions.
The horizontal dotted line denotes $p = 0.05$ in log-scale.

```{r control-batch}

normalization.summary$control.batch$fplot

```

The following plots show regression coefficients when
each principal component is regressed against each batch variable level
along with 95% confidence intervals.
Cases significantly different from zero are coloured red
(p < `r normalization.summary$parameters$batch.threshold`, t-test).

```{r control-batch-detail}

do.call(grid.arrange, c(normalization.summary$control.batch$cplots, list(ncol=2)))

```

```{r control-batch-table}

tab <- normalization.summary$control.batch$tab
tab <- tab[which(tab$p.value < normalization.summary$parameters$batch.threshold),]
for (i in 1:ncol(tab)) {
    if (is.numeric(tab[,i])) {
        tab[,i] <- format(tab[,i], digits=3)
        tab[,i] <- sub("^[ ]*NA$", "", tab[,i])
    }
    if (any(is.na(tab[,i])))
        tab[which(is.na(tab[,i])),i] <- ""
}
if(nrow(tab) > 0) kable(tab,row.names=F)

```


```{r probe-batch-pca-option}
child.filename <- file.path(path, "blank.rmd")
if (!is.null(normalization.summary$probe.batch$pc.plot))
    child.filename <- file.path(path, "probe-batch-pca.rmd")
```

```{r probe-batch-pca-child, child=child.filename}
```

## Normalized probe associations with measured batch variables

The most variable normalized probes were extracted, decomposed into
principal components and each component regressed against each batch
variable. If the normalization has performed well then there will be
no associations between normalized probe PCs and batch
variables. Horizontal dotted line denotes $p = 0.05$ in log-scale.

```{r probe-batch}

normalization.summary$probe.batch$fplot

```

The following plots show regression coefficients when
each principal component is regressed against each batch variable level
along with 95% confidence intervals.
Cases significantly different from zero are coloured red
(p < `r normalization.summary$parameters$batch.threshold`, t-test).

```{r probe-batch-detail}

do.call(grid.arrange, c(normalization.summary$probe.batch$cplots, list(ncol=2)))

```

```{r probe-batch-table}

tab <- normalization.summary$probe.batch$tab
tab <- tab[which(tab$p.value < normalization.summary$parameters$batch.threshold),]
for (i in 1:ncol(tab)) {
    if (is.numeric(tab[,i])) {
        tab[,i] <- format(tab[,i], digits=3)
        tab[,i] <- sub("^[ ]*NA$", "", tab[,i])
    }
    if (any(is.na(tab[,i])))
        tab[which(is.na(tab[,i])),i] <- ""
}
if(nrow(tab) > 0) kable(tab,row.names=F)

```
