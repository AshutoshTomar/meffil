
```{r qc-init, echo=FALSE}

library(knitr)
library(Cairo)
opts_chunk$set(warning=FALSE, echo=FALSE, message=FALSE, results="asis", fig.width=12, fig.height=12, dev="CairoPNG")

```


# QC report
- study: `r study`
- author: "`r author`"
- date: "`r format(Sys.time(), '%d %B, %Y')`"

## Parameters used for QC

```{r qc-parameters, results="markup"}
qc.summary$parameters
```


## Sex mismatches

There are `r sum(qc.summary$sex.summary$tab$outliers)` sex detection outliers, and `r sum(qc.summary$sex.summary$tab$sex.mismatch == "FALSE")` sex detection mismatches.

```{r sex-summary}

tab <- qc.summary$sex.check
if(nrow(tab) > 0) kable(tab)

```

This is a plot of the `xy.diff` values estimated from the methylation data.

```{r sex-graph}

qc.summary$sex.summary$graph

```


## Methylated vs unmethylated

There are `r sum(qc.summary$meth.unmeth.summary$tab$outliers)` outliers from the meth vs unmeth comparison.

```{r meth-unmeth-summary}

tab <- subset(qc.summary$meth.unmeth.summary$tab, outliers)
if(nrow(tab) > 0) kable(tab)

```

This is a plot of the methylation signals vs unmethylated signals

```{r meth-unmeth-graph}

qc.summary$meth.unmeth.summary$graph

```


## Control probe means

There were `r sum(qc.summary$controlmeans.summary$tab$outliers)` outliers detected based on deviations from mean values for control probes.

```{r controlmeans-summary}

tab <- subset(qc.summary$controlmeans.summary$tab, outliers)
if(nrow(tab) > 0) kable(tab)

```

The distribution of sample control means are plotted here:

```{r controlmeans-graph}

qc.summary$controlmeans.summary$graph

```


## Sample detection p-values

There were `r sum(qc.summary$sample.detectionp.summary$tab$outliers)` outliers detected based on having high detection p-values

```{r sample-detectionp-summary}

tab <- subset(qc.summary$sample.detectionp.summary$tab, outliers)
if(nrow(tab) > 0) kable(tab)

```

Distribution:

```{r sample-detectionp-graph}

qc.summary$sample.detectionp.summary$graph

```


## Sample bead numbers

There were `r sum(qc.summary$sample.beadnum.summary$tab$outliers)` outliers detected based on having low average bead numbers

```{r sample-beadnum-summary}

tab <- subset(qc.summary$sample.beadnum.summary$tab, outliers)
if(nrow(tab) > 0) kable(tab)

```

Distribution:

```{r sample-beadnum-graph}

qc.summary$sample.beadnum.summary$graph

```


## CpG detection p-values

There were `r sum(qc.summary$cpg.detectionp.summary$tab$outliers)` CpGs with high proportion of high detection p-values.
Manhattan plot of proportion of samples with detection p-value > 0.01 for CpGs shown below. Black horizontal line represents threshold of `r qc.summary$parameters$detectionp.cpgs.threshold`.

```{r cpg-detectionp-graph}

qc.summary$cpg.detectionp.summary$graph

```

## CpG low bead numbers

There were `r sum(qc.summary$cpg.beadnum.summary$tab$outliers)` CpGs with high proportion of samples with low bead numbers.
Manhattan plot of proportion of samples with bead number less than 3 for CpGs shown below. Black horizontal line represents threshold of `r qc.summary$parameters$beadnum.cpgs.threshold`.

```{r cpg-beadnum-graph}

qc.summary$cpg.beadnum.summary$graph

```

## Cell count estimates

```{r cell-counts-option}
child.filename <- file.path(path, if (!is.null(qc.summary$cell.counts)) 'cell-counts.rmd' else 'missing.rmd')
```

```{r cell-counts-report, child = child.filename}
``` 
