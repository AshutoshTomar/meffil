#' Dye bias correction
#'
#' Adjusts dye bias by scaling each color channel to have the same mean intensity.
#'
#' Infinium HumanMethylation450 BeadChip
#' @param rg Cy5/Cy3 signal generated by \code{\link{read.rg}()}.
#' @param intensity Intensity of both color channels after correct (Default: 5000).
#' @return Cy5/Cy3 signals with average intensity equal to \code{intensity}.
dye.bias.correct <- function(rg, intensity=5000, verbose=F) {
    msg(verbose=verbose)
    stopifnot(is.rg(rg))
    stopifnot(intensity >= 100)

    rg$R[,"Mean"] <- rg$R[,"Mean"] * intensity/calculate.intensity.R(rg)
    rg$G[,"Mean"] <- rg$G[,"Mean"] * intensity/calculate.intensity.G(rg)
    rg
}

calculate.intensity.R <- function(rg) {
     probes <- meffil.probe.info()
     addresses <- probes$address[which(probes$target %in% c("NORM_A", "NORM_T")
                                       & probes$dye == "R")]
    idx <- match(addresses, rownames(rg$R))
    idx <- na.omit(idx)
    stopifnot(length(idx) >= 10) ## there are 93 in total

    mean(rg$R[idx,"Mean"], na.rm=T)
}

calculate.intensity.G <- function(rg) {
    probes <- meffil.probe.info()
    addresses <- probes$address[which(probes$target %in% c("NORM_G", "NORM_C")
                                      & probes$dye == "G")]
    idx <- match(addresses, rownames(rg$G))
    idx <- na.omit(idx)
    stopifnot(length(idx) >= 10) ## there are 93 in total

    mean(rg$G[idx,"Mean"], na.rm=T)
}

