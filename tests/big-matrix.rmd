# File-backed `big.matrix` for minimal memory use

## Download the example dataset (EPIC-Italy)

Retrieve the dataset IDAT files from GEO:
```
wget ftp://ftp.ncbi.nlm.nih.gov/geo/series/GSE51nnn/GSE51032/suppl/GSE51032_RAW.tar
tar xvf GSE51032_RAW.tar
gunzip *.gz
```

Possibly related to following studies:

> Demetriou, et al.
> Methylome analysis and epigenetic changes associated with menarcheal age.
> PLoS One. 2013 Nov 20;8(11):e79391. doi: 10.1371/journal.pone.0079391. eCollection 2013.
> PMID: 24278132 

> Stringhini, et al.
> Life-course socioeconomic status and DNA methylation of genes regulating inflammation.
> Int J Epidemiol. 2015 Apr 17. pii: dyv060. [Epub ahead of print]
> PMID: 25889032

Set `path` to be the location of the IDAT files for the dataset.
```{r}
path <- "~/work/data/GSE51032-epic"
```

## Perform pre-normalization steps

```{r}
library(meffil)
options(mc.cores=8)
samplesheet <- meffil.create.samplesheet(path)
```

```{r big-matrix-qc-objects,cache=T}
qc.objects <- meffil.qc(samplesheet)
```

```{r big-matrix-norm-quantiles,cache=T}
norm.objects <- meffil.normalize.quantiles(qc.objects, number.pcs=10)
```

## Normalize with file-backed `big.matrix`

```{r big-matrix-file-backed,cache=T}
dir.create(cache.dir <- "big-matrix-cache")

file.time <- system.time(file.norm <- meffil.normalize.samples(norm.objects,
                                                               just.beta=F,
                                                               filename=file.path(cache.dir, ""),
                                                               verbose=T))
```

In a later R session, it is possible reload the file-backed
matrices as follows:
```{r}
file.norm$M <- attach.big.matrix("M.desc", backingpath=cache.dir)
file.norm$U <- attach.big.matrix("U.desc", backingpath=cache.dir)                           
```

## Normalize with memory-backed `big.matrix`

```{r big-matrix-memory-backed,cache=T}
mem.time <- system.time(mem.norm <- meffil.normalize.samples(norm.objects,
                                                             just.beta=F,
                                                             verbose=T))
## convert to R matrices
mem.norm$M <- mem.norm$M[]
mem.norm$U <- mem.norm$U[]

## knitr cannot handle caching such large objects
save(mem.norm, file="cache/mem-norm.rda")
rm(mem.norm) 
```

```{r}
load("cache/mem-norm.rda")
```

## Comparison

```{r}
quantile(mem.norm$M - file.norm$M[], na.rm=T)
quantile(mem.norm$U - file.norm$U[], na.rm=T)
```

```{r}
mem.time
file.time
```

## Minfi

```{r, eval=F}
library(minfi, quietly=TRUE)
raw.minfi <- read.450k.exp(base = path)
minfi.time <- system.time(norm.minfi <- preprocessFunnorm(raw.minfi, nPCs=10,
                                                          sex=NULL, bgCorr=TRUE, dyeCorr=TRUE,
                                                          verbose=TRUE))
beta.minfi <- getBeta(norm.minfi)
```


